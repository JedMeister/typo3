#!/bin/sh -ex

DB_NAME=typo3
DB_USER=typo3
DB_PASS=$(mcookie)

ADMIN_NAME=admin
ADMIN_PASS=turnkey1

SRC=/usr/local/src
WEBROOT=/var/www/typo3

# unpack and set required permissions
mkdir -p $WEBROOT
tar -zxf $SRC/typo3_src-*.tar.gz -C $(dirname $WEBROOT)
rm $SRC/typo3_src-*.tar.gz

cd $WEBROOT
ln -s ../typo3_src-* typo3_src
ln -s typo3_src/index.php index.php
ln -s typo3_src/typo3 typo3
cd -

chown -R www-data:www-data $WEBROOT
touch $WEBROOT/FIRST_INSTALL

CONF=/etc/php5/apache2/php.ini

sed -i -e " \
    s|^\(upload_max_filesize =\) .*$|\1 10M|; \
    s|^\(memory_limit =\) .*$|\1 64M|; \
    s|^\(max_execution_time =\) .*$|\1 240| \
" $CONF

sed -i -e "s|^\(memory_limit =\) .*$|\1 64M|;" /etc/php5/cli/php.ini

# configure apache
a2dissite 000-default
a2ensite typo3
a2enmod rewrite
a2enmod expires

# start services
service mysql start
service apache2 start

# setup the database
MYSQL_BATCH="mysql --user=root --password=$MYSQL_PASS --batch"
MYSQL_ADMIN="mysqladmin --user=root --password=$MYSQL_PASS"

$MYSQL_ADMIN create $DB_NAME
$MYSQL_BATCH --execute "grant all privileges on $DB_NAME.* to $DB_USER@localhost identified by '$DB_PASS'; flush privileges;"

cat > /tmp/typo3.twill <<EOF
go http://127.0.0.1

fv 1 1 nop
submit
fv 1 username $DB_USER
fv 1 password $DB_PASS
fv 1 9 tcp
submit
fv 1 existing $DB_NAME
submit
fv 1 username $ADMIN_NAME
fv 1 password $ADMIN_PASS
fv 1 sitename 'TurnKey TYPO3'
submit
fv 1 loaddistributions 0
submit
EOF

twill-sh /tmp/typo3.twill
rm -f $WEBROOT/_.htaccess /tmp/typo3.twill

$MYSQL_BATCH --execute "INSERT INTO typo3.be_users (username, password) VALUES ('_cli_lowlevel', 'null');"

su - www-data -s /bin/bash << EOF
cd $WEBROOT/typo3conf/ext
curl -O https://raw.githubusercontent.com/oliversalzburg/typo3scripts/master/extExtract.php

php extExtract.php --output-dir="$WEBROOT/typo3conf/ext/bootstrap_package" --base="$WEBROOT/typo3" --force-version=6.2.13 bootstrap_package
php extExtract.php --output-dir="$WEBROOT/typo3conf/ext/realurl" --base="$WEBROOT/typo3" --force-version=1.13.3 realurl
php extExtract.php --output-dir="$WEBROOT/typo3conf/ext/introduction" --base="$WEBROOT/typo3" --force-version=2.2.0 introduction

$WEBROOT/typo3/cli_dispatch.phpsh extbase extension:install bootstrap_package
$WEBROOT/typo3/cli_dispatch.phpsh extbase extension:install realurl

rm -rf $WEBROOT/typo3temp/autoload
$WEBROOT/typo3/cli_dispatch.phpsh extbase extension:install introduction
rm -f extExtract.php
EOF

chown -R www-data:www-data $WEBROOT/typo3temp
chown -R www-data:www-data $WEBROOT/typo3conf

# stop services
service mysql stop
service apache2 stop

