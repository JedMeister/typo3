#!/bin/sh -ex

DB_NAME=typo3
DB_USER=typo3
DB_PASS=$(mcookie)

ADMIN_NAME=admin
ADMIN_PASS=turnkey

SRC=/usr/local/src
WEBROOT=/var/www/typo3
VERSION="6.0" # keep insync with conf.d/downloads (major version)

# unpack and set required permissions
tar -zxf $SRC/introductionpackage-*.tar.gz -C $(dirname $WEBROOT)
mv $(dirname $WEBROOT)/introductionpackage-* $WEBROOT
rm $SRC/introductionpackage-*.tar.gz
chown -R root:root $WEBROOT
chown -R www-data:www-data $WEBROOT/uploads
chown -R www-data:www-data $WEBROOT/fileadmin
chown -R www-data:www-data $WEBROOT/typo3temp
chown -R www-data:www-data $WEBROOT/typo3conf
chown -R www-data:www-data $WEBROOT/typo3/ext

# configure apache
a2dissite 000-default
a2ensite typo3
a2enmod rewrite

# start services
/etc/init.d/mysql start
/etc/init.d/apache2 start

# setup the database
MYSQL_BATCH="mysql --user=root --password=$MYSQL_PASS --batch"
MYSQL_ADMIN="mysqladmin --user=root --password=$MYSQL_PASS"

$MYSQL_ADMIN create $DB_NAME
$MYSQL_BATCH --execute "grant all privileges on $DB_NAME.* to $DB_USER@localhost identified by '$DB_PASS'; flush privileges;"

# curl based install
URL="http://127.0.0.1/typo3/install/index.php?mode=123"
URL_CONFIG="${URL}&TYPO3_INSTALL\[type\]=config&"
URL_DATABASE="${URL}&TYPO3_INSTALL\[type\]=database&"
CURL="curl -c /tmp/cookie -b /tmp/cookie"

$CURL "${URL}&step=1&password=joh316"
$CURL "${URL}&step=1&password=joh316"
$CURL "${URL_CONFIG}step=1" --data "step=2"
$CURL "${URL_CONFIG}step=2" --data "step=3&TYPO3_INSTALL%5BLocalConfiguration%5D%5BencryptionKey%5D=$(mcookie)$(mcookie)$(mcookie)&TYPO3_INSTALL%5BLocalConfiguration%5D%5Bcompat_version%5D=$VERSION&TYPO3_INSTALL%5BDatabase%5D%5Btypo_db_driver%5D=mysql&TYPO3_INSTALL%5BDatabase%5D%5Btypo_db_username%5D=$DB_USER&TYPO3_INSTALL%5BDatabase%5D%5Btypo_db_password%5D=$DB_PASS&TYPO3_INSTALL%5BDatabase%5D%5Btypo_db_host%5D=localhost"
$CURL "${URL_CONFIG}step=3" --data "step=4&TYPO3_INSTALL%5Bdb_select_option%5D=EXISTING&TYPO3_INSTALL%5BDatabase%5D%5Btypo_db%5D=$DB_NAME"
$CURL "${URL_DATABASE}step=4"
$CURL "${URL_DATABASE}step=5" --data "systemToInstall=Introduction&TYPO3_INSTALL%5Bdatabase_type%5D=import%7CCURRENT_TABLES%2BSTATIC&TYPO3_INSTALL%5Bdatabase_import_all%5D=1"
$CURL "${URL_DATABASE}step=5&systemToInstall=Introduction"
$CURL "${URL_DATABASE}step=5&subpackage=Introduction"
$CURL "${URL_DATABASE}step=6" --data "password=$ADMIN_PASS&useRealURL=1&colorPicker=%23F18F0B"

rm -f /tmp/cookie

# secure sensitive files
chmod 640 $WEBROOT/typo3conf/LocalConfiguration.php

# stop services
/etc/init.d/mysql stop
/etc/init.d/apache2 stop

